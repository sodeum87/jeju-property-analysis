<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œë“¬ë¶€ë™ì‚° í†µí•© ìƒê¶Œë¶„ì„ ì‹œìŠ¤í…œ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #343A40;
            line-height: 1.6;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 1.125rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 1.5rem 1rem;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .nav-tab.active {
            background: white;
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }

        .tab-content {
            display: none;
            padding: 2rem;
        }

        .tab-content.active {
            display: block;
        }

        .input-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .input-field {
            flex: 1;
            padding: 1rem 1.25rem;
            border: 1px solid #DEE2E6;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 400;
            background: #FFFFFF;
            transition: all 0.2s ease;
            outline: none;
        }

        .input-field:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .analyze-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .analyze-button:hover {
            background: #45A049;
        }

        .analyze-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem 0;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 2px solid #E0E0E0;
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #6C757D;
            font-size: 0.95rem;
        }

        .result-section {
            display: none;
            margin-top: 2rem;
        }

        .result-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4CAF50;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6C757D;
        }

        .report-container {
            background: #FFFFFF;
            border: 1px solid #E9ECEF;
            border-radius: 8px;
            padding: 2rem;
        }

        .report-content {
            font-family: 'Pretendard', sans-serif;
            font-size: 0.95rem;
            line-height: 1.8;
            color: #343A40;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 60vh;
            overflow-y: auto;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 2rem;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .iframe-container {
            width: 100%;
            height: 600px;
            border: 2px solid #4CAF50;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.15);
            margin-bottom: 1rem;
        }

        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .iframe-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .control-button {
            background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .control-button.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .control-button.warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }

        .upload-section {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin-top: 1rem;
        }

        .upload-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .upload-zone {
            border: 2px dashed #4CAF50;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            background: #f8fff8;
            transition: all 0.3s;
            cursor: pointer;
            width: 100%;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .upload-zone:hover {
            background: #f0f8f0;
            border-color: #45A049;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .pdf-result {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 2rem;
            border-left: 4px solid #4CAF50;
            min-height: 400px;
        }

        .error-message {
            background: #FFF3CD;
            border: 1px solid #FFEAA7;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 0.9rem;
            display: none;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .smart-quality {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .pdf-analysis-result {
            font-family: 'Pretendard', sans-serif;
            line-height: 1.8;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            margin: 1rem 0;
        }

        .analysis-header {
            text-align: center;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }

        .analysis-title {
            color: #2c3e50;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .analysis-subtitle {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }

        .analysis-content {
            white-space: pre-line;
            font-size: 0.95rem;
            line-height: 1.8;
            color: #2c3e50;
        }

        .metric-highlight {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .info-unavailable {
            color: #6c757d;
            font-style: italic;
        }

        .success-indicator {
            color: #28a745;
            font-weight: 600;
        }

        .warning-indicator {
            color: #ffc107;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .input-section {
                flex-direction: column;
            }

            .result-stats {
                flex-direction: column;
                gap: 1rem;
            }

            .iframe-container {
                height: 400px;
            }

            .iframe-controls {
                flex-direction: column;
                align-items: center;
            }

            .pdf-analysis-result {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ì†Œë“¬ë¶€ë™ì‚° í†µí•© ìƒê¶Œë¶„ì„ ì‹œìŠ¤í…œ</h1>
            <p class="subtitle">ì„œë²„ê¸°ë°˜ AI ì—”ì§„ ë¶„ì„ â€¢ ì†Œë“¬ ì‹¤ì‹œê°„ ìƒê¶Œ ë¶„ì„</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="ai-analysis">AI ì—”ì§„ ë¶„ì„</button>
            <button class="nav-tab" data-tab="realtime">ì†Œë“¬ ì‹¤ì‹œê°„ ìƒê¶Œ ë¶„ì„</button>
        </div>

        <!-- AI ì—”ì§„ ë¶„ì„ íƒ­ -->
        <div id="ai-analysis" class="tab-content active">
            <div class="input-section">
                <input 
                    type="text" 
                    class="input-field" 
                    id="address-input" 
                    placeholder="ë¶„ì„í•  ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì œì£¼ì‹œ êµ¬ë‚¨ë¡œ7ê¸¸ 11)"
                >
                <button class="analyze-button" id="analyze-btn">ìƒê¶Œë¶„ì„ ì‹œì‘</button>
            </div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                                    <div class="loading-text">ì„œë²„ AI ì—”ì§„ì´ ê³µê³µë°ì´í„°ì™€ ë„¤ì´ë²„ APIë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>

            <div class="error-message" id="error-message"></div>

            <div class="result-section" id="result-section">
                <div class="result-stats" id="result-stats"></div>
                <div class="report-container">
                    <div class="report-content" id="report-content"></div>
                </div>
            </div>
        </div>

        <!-- ì‹¤ì‹œê°„ ë¶„ì„ íƒ­ -->
        <div id="realtime" class="tab-content">
            <div class="info-box">
                <strong>ğŸ’¡ ì†Œë“¬ ì‹¤ì‹œê°„ ìƒê¶Œë¶„ì„:</strong><br>
                â€¢ ì „êµ­ 1200+ ì£¼ìš”ìƒê¶Œ ì‹¤ì‹œê°„ ë°ì´í„°<br>
                â€¢ ì§€ì—­ë³„ ì—…ì¢… ë¶„í¬ ë° ê²½ìŸ í˜„í™©<br>
                â€¢ ìœ ë™ì¸êµ¬, ë§¤ì¶œ ë°ì´í„° ì‹œê°í™”<br>
                â€¢ ëŒ€í™”í˜• ì§€ë„ ë° ê·¸ë˜í”„ ë¶„ì„
            </div>
            
            <div class="iframe-container">
                <iframe src="https://bigdata.sbiz.or.kr/#/openApi/detail?certKey=211032e7c09b05f6c5ed67985eae269d6446e93a8748ab63602fb121b44b7943"></iframe>
            </div>
            
            <div class="iframe-controls">
                <button class="control-button" onclick="refreshIframe()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <button class="control-button warning" onclick="toggleFullscreen()">ğŸ“º ì „ì²´í™”ë©´</button>
                <button class="control-button secondary" onclick="openInNewWindow()">ğŸ”— ìƒˆ ì°½ì—ì„œ ì—´ê¸°</button>
            </div>
        </div>

        <!-- ì •í™•í•œ PDF ë¶„ì„ íƒ­ -->
        <div id="pdf" class="tab-content">
            <div class="upload-section">
                <div class="upload-controls">
                    <h3 style="margin-bottom: 1rem;">ğŸ“„ ìƒê¶Œë¶„ì„ PDF ì •í™•í•œ ì¶”ì¶œ ë¶„ì„</h3>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">ğŸ“</div>
                        <h4>í´ë¦­í•˜ì—¬ PDF íŒŒì¼ ì„ íƒ</h4>
                        <p>ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                        <small>ì§€ì› í˜•ì‹: PDF (ìµœëŒ€ 10MB)</small>
                    </div>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                    
                    <div style="text-align: center; margin-top: 1rem;">
                        <button class="analyze-button" id="pdf-analyze-btn" disabled>ğŸš€ ì‹¤ì œ PDF í…ìŠ¤íŠ¸ ë¶„ì„ ì‹œì‘</button>
                    </div>

                    <div class="info-box">
                        <strong>ğŸ¯ ê°œì„ ëœ ì •í™•í•œ ë¶„ì„:</strong><br>
                        â€¢ <span class="success-indicator">âœ… PDF.jsë¡œ ì‹¤ì œ í…ìŠ¤íŠ¸ ì¶”ì¶œ</span><br>
                        â€¢ <span class="success-indicator">âœ… ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ì •í™•í•œ ë°ì´í„° íŒŒì‹±</span><br>
                        â€¢ <span class="success-indicator">âœ… í™•ì‹¤í•œ ì •ë³´ë§Œ ì¶”ì¶œ (ì•½ 70-80% ì„±ê³µë¥ )</span><br>
                        â€¢ <span class="warning-indicator">âš ï¸ ì¶”ì¶œ ë¶ˆê°€ëŠ¥í•œ ì •ë³´ëŠ” 'ì •ë³´ ì—†ìŒ'ìœ¼ë¡œ ëª…ì‹œ</span><br>
                        â€¢ ê¸°ì¡´ ê°€ìƒ ë°ì´í„° ëŒ€ì‹  ì§„ì§œ PDF ë‚´ìš© ì‚¬ìš©<br>
                        â€¢ ì—…ì†Œí˜„í™©, ë§¤ì¶œ, ê³ ê°íŠ¹ì„±, ê±°ì£¼ì¸êµ¬ ë¶„ì„
                    </div>
                </div>
                
                <div id="pdf-result" class="pdf-result">
                    <div class="analysis-placeholder">
                        <div style="text-align: center; padding: 2rem; color: #6c757d;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“‹</div>
                            <h4>ì‹¤ì œ PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ë¶„ì„ ì‹œìŠ¤í…œ</h4>
                            <p>PDF.js ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì‹¤ì œ PDF í…ìŠ¤íŠ¸ë¥¼ ì½ê³  ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ì •í™•í•œ ë°ì´í„°ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.<br>
                            ê¸°ì¡´ ê°€ìƒ ë°ì´í„° ëŒ€ì‹  ì§„ì§œ PDF ë‚´ìš©ì„ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                            <br>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: left;">
                                <strong>ğŸ“Š ì¶”ì¶œ ê°€ëŠ¥í•œ í™•ì‹¤í•œ ì •ë³´:</strong><br>
                                â€¢ ë¶„ì„ ì§€ì—­: "ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì œì£¼ì‹œ ì´ë„2ë™"<br>
                                â€¢ ë¶„ì„ ì—…ì¢…: "ì¹´í˜"<br>
                                â€¢ ì´ ì—…ì†Œ ìˆ˜: "10ê°œ"<br>
                                â€¢ ì›”í‰ê·  ë§¤ì¶œì•¡: "1,508ë§Œì›"<br>
                                â€¢ ìœ ë™ì¸êµ¬ ì¦ê°ë¥ : "21.7%"<br>
                                â€¢ ìµœê³  ë§¤ì¶œ ì‹œê°„ëŒ€: "14-18ì‹œ (33.3%)"<br>
                                â€¢ ì„±ë³„ ë¶„í¬: "ë‚¨ì„± 50.1%, ì—¬ì„± 49.9%"<br>
                                <br>
                                <strong>ğŸ”§ ì¶”ê°€ ê°œì„ ì‚¬í•­:</strong><br>
                                â€¢ ê±°ì£¼ì¸êµ¬, ì§ì¥ì¸êµ¬, ì„¸ëŒ€ìˆ˜ ì •ë³´ ì¶”ê°€ ì¶”ì¶œ<br>
                                â€¢ PDF êµ¬ì¡°ì— ë”°ë¥¸ ì •í™•ë„ ì°¨ì´ ì¸ì •<br>
                                â€¢ ëª…í™•í•œ ì„±ê³µ/ì‹¤íŒ¨ í‘œì‹œ
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentTab = 'ai-analysis';

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            document.getElementById('address-input').focus();
            console.log('ì„œë²„ ê¸°ë°˜ AI ìƒê¶Œë¶„ì„ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
        });

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
        function initializeEventListeners() {
            // íƒ­ ì „í™˜
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });

            // AI ë¶„ì„ ê´€ë ¨ë§Œ ìœ ì§€
            const addressInput = document.getElementById('address-input');
            const analyzeBtn = document.getElementById('analyze-btn');
            
            addressInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    analyzeBtn.click();
                }
            });
            
            analyzeBtn.addEventListener('click', executeAIAnalysis);
        }

        // íƒ­ ì „í™˜
        function switchTab(tabId) {
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // ì„ íƒëœ íƒ­ í™œì„±í™”
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            currentTab = tabId;
        }

        // AI ë¶„ì„ ì‹¤í–‰ - ì„œë²„ ê¸°ë°˜ ë¶„ì„
        async function executeAIAnalysis() {
            const address = document.getElementById('address-input').value.trim();
            
            if (!address) {
                showToast('ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                document.getElementById('address-input').focus();
                return;
            }

            const loading = document.getElementById('loading');
            const resultSection = document.getElementById('result-section');
            const errorMessage = document.getElementById('error-message');
            const analyzeBtn = document.getElementById('analyze-btn');

            // UI ìƒíƒœ ë³€ê²½
            loading.style.display = 'block';
            resultSection.style.display = 'none';
            errorMessage.style.display = 'none';
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'ì„œë²„ ë¶„ì„ ì¤‘...';

            try {
                console.log(`ğŸ” ì„œë²„ ê¸°ë°˜ AI ìƒê¶Œë¶„ì„ ì‹œì‘: ${address}`);
                
                // ì‹¤ì œ ì„œë²„ API í˜¸ì¶œ
                const response = await fetch('/api/smart-market-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ address: address }),
                    timeout: 30000 // 30ì´ˆ íƒ€ì„ì•„ì›ƒ
                });

                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'ì„œë²„ì—ì„œ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }

                console.log('âœ… ì„œë²„ ë¶„ì„ ì„±ê³µ:', result);
                displayAIResults(result);
                showToast(`AI ë¶„ì„ ì™„ë£Œ (${result.metadata.processingTime})`, 'success');

            } catch (error) {
                console.error('âŒ AI ë¶„ì„ ì˜¤ë¥˜:', error);
                
                let errorMsg = 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg = 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                } else if (error.message.includes('timeout')) {
                    errorMsg = 'ë¶„ì„ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                } else if (error.message) {
                    errorMsg = error.message;
                }
                
                errorMessage.textContent = `ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${errorMsg}`;
                errorMessage.style.display = 'block';
                showToast('ì„œë²„ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                
                // ê°œë°œ ëª¨ë“œì¼ ë•Œë§Œ ìƒì„¸ ì˜¤ë¥˜ ì •ë³´ í‘œì‹œ
                if (window.location.hostname === 'localhost') {
                    console.error('ê°œë°œ ëª¨ë“œ ìƒì„¸ ì˜¤ë¥˜:', {
                        error: error.message,
                        stack: error.stack,
                        address: address
                    });
                }
            } finally {
                loading.style.display = 'none';
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ìƒê¶Œë¶„ì„ ì‹œì‘';
            }
        }

        // AI ê²°ê³¼ í‘œì‹œ - undefined ê°’ ì²˜ë¦¬ ê°œì„ 
        function displayAIResults(result) {
            const resultStats = document.getElementById('result-stats');
            const reportContent = document.getElementById('report-content');
            const resultSection = document.getElementById('result-section');

            const metadata = result.metadata || {};
            
            // í†µê³„ í‘œì‹œ ì‹œ undefinedë‚˜ null ê°’ë“¤ì„ í•„í„°ë§
            const statItems = [];
            
            // ì´ ì—…ì†Œ ìˆ˜ - ìœ íš¨í•œ ê°’ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ
            if (metadata.totalStores && metadata.totalStores !== 'undefined') {
                statItems.push(`
                    <div class="stat-item">
                        <div class="stat-value">${metadata.totalStores}ê°œ</div>
                        <div class="stat-label">ì´ ì—…ì†Œ ìˆ˜</div>
                    </div>
                `);
            }
            
            // AI í’ˆì§ˆì ìˆ˜ - ìœ íš¨í•œ ê°’ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ
            if (metadata.smartQualityScore && metadata.smartQualityScore !== 'undefined') {
                statItems.push(`
                    <div class="stat-item">
                        <div class="stat-value">${metadata.smartQualityScore}ì </div>
                        <div class="stat-label">AI í’ˆì§ˆì ìˆ˜ <span class="smart-quality">ì„œë²„ê¸°ë°˜</span></div>
                    </div>
                `);
            }
            
            // ê³µê³µë°ì´í„° - ìœ íš¨í•œ ê°’ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ
            const publicDataCount = metadata.publicDataCount || metadata.highConfidenceCount;
            if (publicDataCount && publicDataCount !== 'undefined' && publicDataCount !== '0') {
                statItems.push(`
                    <div class="stat-item">
                        <div class="stat-value">${publicDataCount}ê°œ</div>
                        <div class="stat-label">ê³µê³µë°ì´í„°</div>
                    </div>
                `);
            }
            
            // ì²˜ë¦¬ ì‹œê°„ - í•­ìƒ í‘œì‹œ
            if (metadata.processingTime) {
                statItems.push(`
                    <div class="stat-item">
                        <div class="stat-value">${metadata.processingTime}</div>
                        <div class="stat-label">ì²˜ë¦¬ ì‹œê°„</div>
                    </div>
                `);
            }
            
            // ë„¤ì´ë²„ ë°ì´í„° - ìœ íš¨í•œ ê°’ì´ ìˆê³  0ì´ ì•„ë‹ ë•Œë§Œ í‘œì‹œ
            if (metadata.naverDataCount && metadata.naverDataCount !== 'undefined' && metadata.naverDataCount !== 0) {
                statItems.push(`
                    <div class="stat-item">
                        <div class="stat-value">${metadata.naverDataCount}ê°œ</div>
                        <div class="stat-label">ë„¤ì´ë²„ ë°ì´í„°</div>
                    </div>
                `);
            }
            
            // ë°ì´í„° í’ˆì§ˆ - ìœ íš¨í•œ ê°’ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ
            if (metadata.dataIntegrity && metadata.dataIntegrity !== 'undefined') {
                statItems.push(`
                    <div class="stat-item">
                        <div class="stat-value">${metadata.dataIntegrity}</div>
                        <div class="stat-label">ë°ì´í„° í’ˆì§ˆ</div>
                    </div>
                `);
            }
            
            // í†µê³„ ì„¹ì…˜ì— ìœ íš¨í•œ í•­ëª©ë“¤ë§Œ í‘œì‹œ
            resultStats.innerHTML = statItems.join('');

            // ì„œë²„ì—ì„œ ë°›ì€ ë¦¬í¬íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ í‘œì‹œ
            reportContent.textContent = result.report;
            resultSection.style.display = 'block';
            
            // ì¶”ê°€ ë¶„ì„ ì •ë³´ê°€ ìˆë‹¤ë©´ í‘œì‹œ
            if (result.businessAnalysis) {
                console.log('ğŸ“Š ì—…ì¢… ë¶„ì„ ë°ì´í„°:', result.businessAnalysis);
            }
            
            if (result.location) {
                console.log('ğŸ“ ìœ„ì¹˜ ì •ë³´:', result.location);
            }
            
            // ê²°ê³¼ë¡œ ìŠ¤ë¬´ìŠ¤ ìŠ¤í¬ë¡¤
            setTimeout(() => {
                resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // PDF íŒŒì¼ ì²˜ë¦¬
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                if (validateFileSize(file)) {
                    uploadedFile = file;
                    document.getElementById('pdf-analyze-btn').disabled = false;
                    updateUploadZone(file);
                    showToast(`PDF íŒŒì¼ "${file.name}"ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }
            } else {
                showToast('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
            }
        }

        // ì—…ë¡œë“œ ì¡´ ì—…ë°ì´íŠ¸
        function updateUploadZone(file) {
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.innerHTML = `
                <div class="upload-icon">ğŸ“„</div>
                <h4>íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!</h4>
                <p><strong>${file.name}</strong></p>
                <small>í¬ê¸°: ${(file.size / 1024 / 1024).toFixed(2)}MB | ë¶„ì„ ì¤€ë¹„ ì™„ë£Œ</small>
            `;
        }

        // íŒŒì¼ í¬ê¸° ê²€ì¦
        function validateFileSize(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showToast('íŒŒì¼ í¬ê¸°ê°€ 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. ë” ì‘ì€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return false;
            }
            return true;
        }

        // ì‹¤ì œ PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ
        async function extractPDFText(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = '';
                console.log(`PDF ì´ í˜ì´ì§€ ìˆ˜: ${pdf.numPages}`);
                
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += `[í˜ì´ì§€ ${pageNum}] ${pageText}\n\n`;
                }
                
                console.log('PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ì„±ê³µ:', fullText.substring(0, 300) + '...');
                return fullText;
            } catch (error) {
                console.error('PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨:', error);
                throw new Error('PDF íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ ì•”í˜¸í™”ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì •í™•í•œ ë°ì´í„° ì¶”ì¶œ í•¨ìˆ˜ (ì‹¤ì œ PDF ê¸°ë°˜) - í•¨ìˆ˜ ì •ì˜ ìˆœì„œ ìˆ˜ì •
        function extractAccurateDataFromPDF(pdfText) {
            console.log('PDF í…ìŠ¤íŠ¸ ë¶„ì„ ì‹œì‘...');
            console.log('PDF ìƒ˜í”Œ:', pdfText.substring(0, 500));
            
            return {
                region: extractRegionInfo(pdfText),
                business: extractBusinessInfo(pdfText),
                totalStores: extractStoreCount(pdfText),
                storeChange: extractStoreChange(pdfText),
                avgSales: extractSalesAmount(pdfText),
                salesChange: extractSalesChangeRate(pdfText), // í•¨ìˆ˜ëª… ë³€ê²½
                avgTransactions: extractTransactionCount(pdfText),
                transactionChange: extractTransactionChangeRate(pdfText), // í•¨ìˆ˜ëª… ë³€ê²½
                footTraffic: extractFootTraffic(pdfText),
                footTrafficChange: extractFootTrafficChangeRate(pdfText), // í•¨ìˆ˜ëª… ë³€ê²½
                peakHours: extractPeakHours(pdfText),
                bestDay: extractBestDay(pdfText),
                genderRatio: extractGenderRatio(pdfText),
                residentPopulation: extractResidentPopulation(pdfText),
                workingPopulation: extractWorkingPopulation(pdfText),
                households: extractHouseholds(pdfText)
            };
        }

        // ë§¤ì¶œ ì¦ê°ë¥  ì¶”ì¶œ (í•¨ìˆ˜ëª… ë³€ê²½ìœ¼ë¡œ ì¶©ëŒ ë°©ì§€)
        function extractSalesChangeRate(text) {
            const patterns = [
                /ë§¤ì¶œ.*?ì¦ê°.*?([+-]?\d+\.?\d*)%/g,
                /ë§¤ì¶œ.*?ì „ì›”ëŒ€ë¹„.*?([+-]?\d+\.?\d*)%/g,
                /ë§¤ì¶œ.*?ì „ë…„ëŒ€ë¹„.*?([+-]?\d+\.?\d*)%/g,
                /([+-]?\d+\.?\d*)%.*?ë§¤ì¶œ.*?ì¦ê°€/g,
                /([+-]?\d+\.?\d*)%.*?ë§¤ì¶œ.*?ê°ì†Œ/g,
                /(\d+)[\s]*ë§Œì›.*?([+-]?\d+\.?\d*)%/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const match = matches[0];
                    const change = match[2] || match[1];
                    if (change !== undefined) {
                        console.log(`ë§¤ì¶œ ì¦ê°ë¥  ì¶”ì¶œ ì„±ê³µ: ${change}%`);
                        return change;
                    }
                }
            }
            return null;
        }

        // ê±°ë˜ëŸ‰ ì¦ê°ë¥  ì¶”ì¶œ (í•¨ìˆ˜ëª… ë³€ê²½ìœ¼ë¡œ ì¶©ëŒ ë°©ì§€)
        function extractTransactionChangeRate(text) {
            const patterns = [
                /ë§¤ì¶œ[\s]*ê±´ìˆ˜.*?ì¦ê°.*?([+-]?\d+\.?\d*)%/g,
                /ê±°ë˜.*?ì¦ê°.*?([+-]?\d+\.?\d*)%/g,
                /ê±´ìˆ˜.*?ì „ì›”ëŒ€ë¹„.*?([+-]?\d+\.?\d*)%/g,
                /ì „ë…„ëŒ€ë¹„.*?ê±°ë˜.*?([+-]?\d+\.?\d*)%/g,
                /(\d+)[\s]*ê±´.*?([+-]?\d+\.?\d*)%/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const match = matches[0];
                    const change = match[2] || match[1];
                    if (change !== undefined) {
                        console.log(`ê±°ë˜ëŸ‰ ì¦ê°ë¥  ì¶”ì¶œ ì„±ê³µ: ${change}%`);
                        return change;
                    }
                }
            }
            return null;
        }

        // ìœ ë™ì¸êµ¬ ì¦ê°ë¥  ì¶”ì¶œ (í•¨ìˆ˜ëª… ë³€ê²½ìœ¼ë¡œ ì¶©ëŒ ë°©ì§€)
        function extractFootTrafficChangeRate(text) {
            const patterns = [
                /ìœ ë™[\s]*ì¸êµ¬.*?ì¦ê°.*?([+-]?\d+\.?\d*)%/g,
                /ì¸êµ¬.*?ì¦ê°.*?([+-]?\d+\.?\d*)%/g,
                /ì „ë…„ë™ì›”ëŒ€ë¹„.*?([+-]?\d+\.?\d*)%.*?ë§ìŠµë‹ˆë‹¤/g,
                /ì „ë…„ëŒ€ë¹„.*?([+-]?\d+\.?\d*)%.*?ìœ ë™/g,
                /([+-]?\d+\.?\d*)%.*?ì¦ê°€/g,
                /([+-]?\d+\.?\d*)%.*?ê°ì†Œ/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const change = matches[0][1];
                    if (change !== undefined) {
                        console.log(`ìœ ë™ì¸êµ¬ ì¦ê°ë¥  ì¶”ì¶œ ì„±ê³µ: ${change}%`);
                        return change;
                    }
                }
            }
            return null;
        }

        // ì§€ì—­ ì •ë³´ ì¶”ì¶œ (ë‹¤ì–‘í•œ í˜•ì‹ ëŒ€ì‘)
        function extractRegionInfo(text) {
            const patterns = [
                // ê¸°ë³¸ ì œì£¼ í˜•ì‹ë“¤
                /ì œì£¼íŠ¹ë³„ìì¹˜ë„\s+ì œì£¼ì‹œ\s+([ê°€-í£]+ë™)/g,
                /ì œì£¼ì‹œ\s+([ê°€-í£]+ë™)/g,
                /([ê°€-í£]+ë™)\s+ìƒê¶Œ/g,
                /ìƒê¶Œë¶„ì„.*?([ê°€-í£]+ë™)/g,
                /ë¶„ì„\s*ì§€ì—­[\s:]*([ê°€-í£]+ë™)/g,
                /ì§€ì—­[\s:]*ì œì£¼.*?([ê°€-í£]+ë™)/g,
                // ì„œê·€í¬ í˜•ì‹
                /ì„œê·€í¬ì‹œ\s+([ê°€-í£]+ë™)/g,
                /ì œì£¼íŠ¹ë³„ìì¹˜ë„\s+ì„œê·€í¬ì‹œ\s+([ê°€-í£]+ë™)/g,
                // ìë©´ í˜•ì‹
                /ì œì£¼ì‹œ\s+([ê°€-í£]+ì)/g,
                /ì„œê·€í¬ì‹œ\s+([ê°€-í£]+ë©´)/g,
                /([ê°€-í£]+ì)\s+([ê°€-í£]+ë¦¬)/g,
                /([ê°€-í£]+ë©´)\s+([ê°€-í£]+ë¦¬)/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const match = matches[0];
                    if (match[1]) {
                        console.log(`ì§€ì—­ ì •ë³´ ì¶”ì¶œ ì„±ê³µ: ${match[1]} (íŒ¨í„´: ${pattern})`);
                        return match[1];
                    }
                }
            }
            return null;
        }

        // ì—…ì¢… ì •ë³´ ì¶”ì¶œ (í™•ì¥ëœ ì—…ì¢… ëª©ë¡)
        function extractBusinessInfo(text) {
            const businessTypes = [
                'ì¹´í˜', 'ì»¤í”¼', 'ìŒì‹ì ', 'í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹', 'ì¹˜í‚¨', 
                'í”¼ì', 'í–„ë²„ê±°', 'ë¶„ì‹', 'ì œê³¼', 'ë² ì´ì»¤ë¦¬', 'í¸ì˜ì ', 'ë§ˆíŠ¸',
                'ì˜ë¥˜', 'í™”ì¥í’ˆ', 'ë¯¸ìš©', 'í•™ì›', 'ë³‘ì›', 'ì•½êµ­', 'ë¶€ë™ì‚°',
                'íœì…˜', 'ìˆ™ë°•', 'ì—¬í–‰', 'ë Œí„°ì¹´', 'ì£¼ì ', 'ìˆ ì§‘', 'ë…¸ë˜ë°©'
            ];
            
            for (let type of businessTypes) {
                if (text.includes(type)) {
                    console.log(`ì—…ì¢… ì •ë³´ ì¶”ì¶œ ì„±ê³µ: ${type}`);
                    return type;
                }
            }
            return null;
        }

        // ì—…ì†Œìˆ˜ ì¶”ì¶œ (ë‹¤ì–‘í•œ í‘œí˜„ í˜•ì‹)
        function extractStoreCount(text) {
            const patterns = [
                /ì—…ì†Œ[\s]*ìˆ˜[\s]*[:\-]?[\s]*(\d+)[\s]*ê°œ/g,
                /ì´[\s]*ì—…ì†Œ[\s]*(\d+)[\s]*ê°œ/g,
                /(\d+)[\s]*ê°œ[\s]*ì—…ì†Œ/g,
                /ì—…ì†Œ[\s]*(\d+)/g,
                /ì í¬[\s]*ìˆ˜[\s]*[:\-]?[\s]*(\d+)/g,
                /ë§¤ì¥[\s]*ìˆ˜[\s]*[:\-]?[\s]*(\d+)/g,
                /ìƒê°€[\s]*ìˆ˜[\s]*[:\-]?[\s]*(\d+)/g,
                /ê°œì†Œ[\s]*ìˆ˜[\s]*[:\-]?[\s]*(\d+)/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const count = matches[0][1];
                    if (count && parseInt(count) > 0) {
                        console.log(`ì—…ì†Œìˆ˜ ì¶”ì¶œ ì„±ê³µ: ${count}ê°œ (íŒ¨í„´: ${pattern})`);
                        return count;
                    }
                }
            }
            return null;
        }

        // ì—…ì†Œ ì¦ê°ë¥  ì¶”ì¶œ
        function extractStoreChange(text) {
            const patterns = [
                /ì—…ì†Œ.*?ì¦ê°.*?([+-]?\d+\.?\d*)%/g,
                /ì „ì›”ëŒ€ë¹„.*?([+-]?\d+\.?\d*)%/g,
                /ì „ë…„ëŒ€ë¹„.*?([+-]?\d+\.?\d*)%/g,
                /ì¦ê°ë¥ [\s]*[:\-]?[\s]*([+-]?\d+\.?\d*)%/g,
                /(\d+)ê°œ[\s]*([+-]?\d+\.?\d*)%/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const change = matches[0][1] || matches[0][2];
                    if (change !== undefined) {
                        console.log(`ì—…ì†Œ ì¦ê°ë¥  ì¶”ì¶œ ì„±ê³µ: ${change}%`);
                        return change;
                    }
                }
            }
            return null;
        }

        // ë§¤ì¶œì•¡ ì¶”ì¶œ (ë‹¤ì–‘í•œ ë‹¨ìœ„ì™€ í‘œí˜„)
        function extractSalesAmount(text) {
            const patterns = [
                /ì›”[\s]*í‰ê· [\s]*ë§¤ì¶œ[\s]*[:\-]?[\s]*(\d{1,4})[,\s]*(\d{3})?[\s]*ë§Œ[\s]*ì›/g,
                /ë§¤ì¶œ[\s]*ì•¡[\s]*[:\-]?[\s]*(\d{1,4})[,\s]*(\d{3})?[\s]*ë§Œ[\s]*ì›/g,
                /(\d{1,4})[,\s]*(\d{3})?[\s]*ë§Œ[\s]*ì›[\s]*ë§¤ì¶œ/g,
                /ë§¤ì¶œ[\s]*[:\-]?[\s]*(\d{1,4})[,\s]*(\d{3})?[\s]*ë§Œ/g,
                /(\d{1,4})[,\s]*(\d{3})?[\s]*ë§Œì›/g,
                /í‰ê· [\s]*(\d+)[\s]*ë§Œì›/g,
                /(\d+)[\s]*ë°±ë§Œì›/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const match = matches[0];
                    let amount;
                    
                    if (match[2]) {
                        // ì²œ ë‹¨ìœ„ êµ¬ë¶„ìê°€ ìˆëŠ” ê²½ìš°
                        amount = match[1] + match[2];
                    } else {
                        amount = match[1];
                    }
                    
                    if (amount && parseInt(amount) > 0) {
                        console.log(`ë§¤ì¶œì•¡ ì¶”ì¶œ ì„±ê³µ: ${amount}ë§Œì› (íŒ¨í„´: ${pattern})`);
                        return amount;
                    }
                }
            }
            return null;
        }

        // ìœ ë™ì¸êµ¬ ì¶”ì¶œ (ë‹¤ì–‘í•œ í‘œí˜„)
        function extractFootTraffic(text) {
            const patterns = [
                /ì¼[\s]*í‰ê· [\s]*ìœ ë™[\s]*ì¸êµ¬[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…/g,
                /ìœ ë™[\s]*ì¸êµ¬[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…/g,
                /(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…[\s]*ìœ ë™/g,
                /ë°©ë¬¸ì[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…/g,
                /ê³ ê°[\s]*ìˆ˜[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const match = matches[0];
                    let count;
                    
                    if (match[2]) {
                        count = match[1] + match[2];
                    } else {
                        count = match[1];
                    }
                    
                    if (count && parseInt(count) > 0) {
                        console.log(`ìœ ë™ì¸êµ¬ ì¶”ì¶œ ì„±ê³µ: ${count}ëª… (íŒ¨í„´: ${pattern})`);
                        return count;
                    }
                }
            }
            return null;
        }

        // ì‹œê°„ëŒ€ ì¶”ì¶œ (ë‹¤ì–‘í•œ ì‹œê°„ í‘œí˜„)
        function extractPeakHours(text) {
            const patterns = [
                /(\d{1,2})[\-~](\d{1,2})ì‹œ.*?ê°€ì¥[\s]*ë§/g,
                /(\d{1,2})ì‹œ[\-~](\d{1,2})ì‹œ.*?ìµœê³ /g,
                /ìµœê³ .*?(\d{1,2})[\-~](\d{1,2})ì‹œ/g,
                /í”¼í¬.*?(\d{1,2})[\-~](\d{1,2})ì‹œ/g,
                /(\d{1,2})[\-~](\d{1,2})ì‹œ.*?ë§¤ì¶œ/g,
                /ë§¤ì¶œ.*?(\d{1,2})[\-~](\d{1,2})ì‹œ/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const match = matches[0];
                    const timeRange = `${match[1]}-${match[2]}ì‹œ`;
                    console.log(`ìµœê³  ë§¤ì¶œ ì‹œê°„ëŒ€ ì¶”ì¶œ ì„±ê³µ: ${timeRange}`);
                    return { time: timeRange, percentage: null };
                }
            }
            return null;
        }

        // ìš”ì¼ ì¶”ì¶œ
        function extractBestDay(text) {
            const patterns = [
                /(ì›”|í™”|ìˆ˜|ëª©|ê¸ˆ|í† |ì¼)ìš”ì¼.*?ê°€ì¥[\s]*ë§/g,
                /(ì›”|í™”|ìˆ˜|ëª©|ê¸ˆ|í† |ì¼)ìš”ì¼.*?ìµœê³ /g,
                /ìµœê³ .*?(ì›”|í™”|ìˆ˜|ëª©|ê¸ˆ|í† |ì¼)ìš”ì¼/g,
                /ë§¤ì¶œ.*?(ì›”|í™”|ìˆ˜|ëª©|ê¸ˆ|í† |ì¼)ìš”ì¼/g,
                /(ì›”|í™”|ìˆ˜|ëª©|ê¸ˆ|í† |ì¼)ìš”ì¼.*?ë§¤ì¶œ/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const day = matches[0][1] + 'ìš”ì¼';
                    console.log(`ìµœê³  ë§¤ì¶œ ìš”ì¼ ì¶”ì¶œ ì„±ê³µ: ${day}`);
                    return { day: day, percentage: null };
                }
            }
            return null;
        }

        // ì„±ë³„ ë¶„í¬ ì¶”ì¶œ (ê°œì„ ëœ íŒ¨í„´)
        function extractGenderRatio(text) {
            const patterns = [
                /ë‚¨ì„±[\s]*[:\-]?[\s]*(\d+\.?\d*)%[\s,]*ì—¬ì„±[\s]*[:\-]?[\s]*(\d+\.?\d*)%/g,
                /ë‚¨[\s]*(\d+\.?\d*)%[\s,]*ì—¬[\s]*(\d+\.?\d*)%/g,
                /ë‚¨ì„±[\s]*(\d+\.?\d*)[\s]*ì—¬ì„±[\s]*(\d+\.?\d*)/g,
                /ì„±ë³„[\s]*ë¶„í¬.*?ë‚¨[\s]*(\d+\.?\d*).*?ì—¬[\s]*(\d+\.?\d*)/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const match = matches[0];
                    console.log(`ì„±ë³„ ë¶„í¬ ì¶”ì¶œ ì„±ê³µ: ë‚¨ì„± ${match[1]}%, ì—¬ì„± ${match[2]}%`);
                    return {
                        male: match[1],
                        female: match[2]
                    };
                }
            }
            
            // ê°œë³„ íŒ¨í„´ìœ¼ë¡œë„ ì‹œë„
            const maleMatch = text.match(/ë‚¨ì„±[\s]*[:\-]?[\s]*(\d+\.?\d*)%/);
            const femaleMatch = text.match(/ì—¬ì„±[\s]*[:\-]?[\s]*(\d+\.?\d*)%/);
            
            if (maleMatch && femaleMatch) {
                console.log(`ì„±ë³„ ë¶„í¬ ê°œë³„ ì¶”ì¶œ ì„±ê³µ: ë‚¨ì„± ${maleMatch[1]}%, ì—¬ì„± ${femaleMatch[1]}%`);
                return {
                    male: maleMatch[1],
                    female: femaleMatch[1]
                };
            }
            
            return { male: null, female: null };
        }

        // ê±°ì£¼ ì¸êµ¬ìˆ˜ ì¶”ì¶œ
        function extractResidentPopulation(text) {
            const patterns = [
                /ê±°ì£¼[\s]*ì¸êµ¬[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…/g,
                /ì£¼ê±°[\s]*ì¸êµ¬[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…/g,
                /ì£¼ë¯¼[\s]*ìˆ˜[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…/g,
                /ê±°ì£¼ì[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…/g,
                /ì¸êµ¬[\s]*ìˆ˜[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const match = matches[0];
                    let count;
                    
                    if (match[2]) {
                        count = match[1] + match[2];
                    } else {
                        count = match[1];
                    }
                    
                    if (count && parseInt(count) > 0) {
                        console.log(`ê±°ì£¼ ì¸êµ¬ìˆ˜ ì¶”ì¶œ ì„±ê³µ: ${count}ëª… (íŒ¨í„´: ${pattern})`);
                        return count;
                    }
                }
            }
            return null;
        }

        // ì§ì¥ ì¸êµ¬ìˆ˜ ì¶”ì¶œ
        function extractWorkingPopulation(text) {
            const patterns = [
                /ì§ì¥[\s]*ì¸êµ¬[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…/g,
                /ê·¼ë¬´[\s]*ì¸êµ¬[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…/g,
                /ì§ì¥ì¸[\s]*ìˆ˜[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…/g,
                /ê·¼ë¡œì[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ëª…/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const match = matches[0];
                    let count;
                    
                    if (match[2]) {
                        count = match[1] + match[2];
                    } else {
                        count = match[1];
                    }
                    
                    if (count && parseInt(count) > 0) {
                        console.log(`ì§ì¥ ì¸êµ¬ìˆ˜ ì¶”ì¶œ ì„±ê³µ: ${count}ëª… (íŒ¨í„´: ${pattern})`);
                        return count;
                    }
                }
            }
            return null;
        }

        // ì„¸ëŒ€ìˆ˜ ì¶”ì¶œ
        function extractHouseholds(text) {
            const patterns = [
                /ì„¸ëŒ€[\s]*ìˆ˜[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ì„¸ëŒ€/g,
                /ì´[\s]*ì„¸ëŒ€[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ì„¸ëŒ€/g,
                /(\d{1,3})[,\s]*(\d{3})?[\s]*ì„¸ëŒ€/g,
                /ê°€êµ¬[\s]*ìˆ˜[\s]*[:\-]?[\s]*(\d{1,3})[,\s]*(\d{3})?[\s]*ê°€êµ¬/g
            ];
            
            for (let pattern of patterns) {
                const matches = [...text.matchAll(pattern)];
                if (matches.length > 0) {
                    const match = matches[0];
                    let count;
                    
                    if (match[2]) {
                        count = match[1] + match[2];
                    } else {
                        count = match[1];
                    }
                    
                    if (count && parseInt(count) > 0) {
                        console.log(`ì„¸ëŒ€ìˆ˜ ì¶”ì¶œ ì„±ê³µ: ${count}ì„¸ëŒ€ (íŒ¨í„´: ${pattern})`);
                        return count;
                    }
                }
            }
            return null;
        }

        // AI ì¸ì‚¬ì´íŠ¸ ìƒì„± í•¨ìˆ˜
        function generateInsights(data) {
            const insights = [];
            
            // ë§¤ì¶œ ê´€ë ¨ ì¸ì‚¬ì´íŠ¸
            if (data.avgSales && data.salesChange) {
                const salesNum = parseFloat(data.avgSales);
                const changeNum = parseFloat(data.salesChange);
                
                if (changeNum > 0) {
                    insights.push(`ğŸ’¡ ë§¤ì¶œ ì„±ì¥ì„¸: ì›”í‰ê·  ë§¤ì¶œ ${salesNum.toLocaleString()}ë§Œì›ìœ¼ë¡œ ì „ì›”ëŒ€ë¹„ +${changeNum}% ì¦ê°€ ì¶”ì„¸ì…ë‹ˆë‹¤.`);
                } else if (changeNum < 0) {
                    insights.push(`âš ï¸ ë§¤ì¶œ ê°ì†Œ ì£¼ì˜: ì „ì›”ëŒ€ë¹„ ${changeNum}% ê°ì†Œë¡œ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
                } else {
                    insights.push(`ğŸ“Š ë§¤ì¶œ ì•ˆì •ì„¸: ì „ì›”ê³¼ ë™ì¼í•œ ìˆ˜ì¤€ìœ¼ë¡œ ì•ˆì •ì ì¸ ë§¤ì¶œì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.`);
                }
            }
            
            // ìœ ë™ì¸êµ¬ ê´€ë ¨ ì¸ì‚¬ì´íŠ¸
            if (data.footTraffic && data.footTrafficChange) {
                const footTrafficNum = parseInt(data.footTraffic);
                const changeNum = parseFloat(data.footTrafficChange);
                
                if (changeNum > 10) {
                    insights.push(`ğŸš€ ìš°ìˆ˜í•œ ì…ì§€: ìœ ë™ì¸êµ¬ ${footTrafficNum.toLocaleString()}ëª…ìœ¼ë¡œ ì „ë…„ëŒ€ë¹„ ${changeNum}% ëŒ€í­ ì¦ê°€í–ˆìŠµë‹ˆë‹¤.`);
                } else if (changeNum > 0) {
                    insights.push(`ğŸ“ˆ ì–‘í˜¸í•œ ìƒê¶Œ: ìœ ë™ì¸êµ¬ê°€ ì „ë…„ëŒ€ë¹„ +${changeNum}% ì¦ê°€í•˜ì—¬ ìƒê¶Œ í™œì„±í™”ê°€ ì§„í–‰ë˜ê³  ìˆìŠµë‹ˆë‹¤.`);
                }
            }
            
            // ì„±ë³„ ë¶„í¬ ì¸ì‚¬ì´íŠ¸
            if (data.genderRatio && data.genderRatio.male && data.genderRatio.female) {
                const maleRatio = parseFloat(data.genderRatio.male);
                const femaleRatio = parseFloat(data.genderRatio.female);
                
                if (Math.abs(maleRatio - femaleRatio) < 5) {
                    insights.push(`âš–ï¸ ê· í˜•ì¡íŒ ê³ ê°ì¸µ: ë‚¨ì„± ${maleRatio}%, ì—¬ì„± ${femaleRatio}%ë¡œ ì„±ë³„ ê· í˜•ì´ ìš°ìˆ˜í•©ë‹ˆë‹¤.`);
                } else if (maleRatio > femaleRatio) {
                    insights.push(`ğŸ‘¨ ë‚¨ì„± ê³ ê° ì¤‘ì‹¬: ë‚¨ì„± ê³ ê°(${maleRatio}%)ì´ ì£¼ìš” íƒ€ê²Ÿì¸µì…ë‹ˆë‹¤.`);
                } else {
                    insights.push(`ğŸ‘© ì—¬ì„± ê³ ê° ì¤‘ì‹¬: ì—¬ì„± ê³ ê°(${femaleRatio}%)ì´ ì£¼ìš” íƒ€ê²Ÿì¸µì…ë‹ˆë‹¤.`);
                }
            }
            
            // ì‹œê°„ëŒ€ ì¸ì‚¬ì´íŠ¸
            if (data.peakHours && data.peakHours.time) {
                insights.push(`â° ìš´ì˜ ìµœì í™”: ${data.peakHours.time} ì‹œê°„ëŒ€ê°€ ìµœê³  ë§¤ì¶œ êµ¬ê°„ì…ë‹ˆë‹¤.`);
            }
            
            // ì—…ì†Œìˆ˜ ê´€ë ¨ ì¸ì‚¬ì´íŠ¸
            if (data.totalStores) {
                const storeCount = parseInt(data.totalStores);
                if (storeCount < 5) {
                    insights.push(`ğŸ¯ ê²½ìŸ ìš°ìœ„: ì—…ì†Œìˆ˜ ${storeCount}ê°œë¡œ ê²½ìŸì´ ì ì–´ ì§„ì…í•˜ê¸° ì¢‹ì€ í™˜ê²½ì…ë‹ˆë‹¤.`);
                } else if (storeCount > 15) {
                    insights.push(`âš¡ ì¹˜ì—´í•œ ê²½ìŸ: ì—…ì†Œìˆ˜ ${storeCount}ê°œë¡œ ì°¨ë³„í™” ì „ëµì´ í•„ìˆ˜ì…ë‹ˆë‹¤.`);
                } else {
                    insights.push(`ğŸ“ ì ì • ê²½ìŸ: ì—…ì†Œìˆ˜ ${storeCount}ê°œë¡œ ì ì ˆí•œ ê²½ìŸ í™˜ê²½ì…ë‹ˆë‹¤.`);
                }
            }
            
            // ê¸°ë³¸ ì¸ì‚¬ì´íŠ¸ ì¶”ê°€
            if (insights.length === 0) {
                insights.push(`ğŸ“‹ ë¶„ì„ ì™„ë£Œ: PDFì—ì„œ ì¶”ì¶œ ê°€ëŠ¥í•œ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìƒê¶Œ í˜„í™©ì„ íŒŒì•…í–ˆìŠµë‹ˆë‹¤.`);
                insights.push(`ğŸ’¼ ì¶”ê°€ ë¶„ì„: ë” ì •í™•í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ ìœ„í•´ ìµœì‹  ë°ì´í„° ìˆ˜ì§‘ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`);
            }
            
            return insights.join('\n');
        }

        // PDF ë¶„ì„ ì‹¤í–‰
        async function analyzePDF() {
            if (!uploadedFile) {
                showToast('PDF íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const resultDiv = document.getElementById('pdf-result');
            const analyzeBtn = document.getElementById('pdf-analyze-btn');
            
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...';
            
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div class="loading-spinner"></div>
                    <h4 style="margin: 1rem 0;">ğŸ“„ ${uploadedFile.name} ì‹¤ì œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...</h4>
                    <p>PDF.js ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì •í™•í•œ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: left;">
                        <small>
                        <strong>ğŸ“Š ì¶”ì¶œ ê³¼ì •:</strong><br>
                        â€¢ PDF íŒŒì¼ ì½ê¸° ë° í˜ì´ì§€ ë¶„ì„<br>
                        â€¢ ê° í˜ì´ì§€ë³„ í…ìŠ¤íŠ¸ ì¶”ì¶œ<br>
                        â€¢ ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ë°ì´í„° íŒŒì‹±<br>
                        â€¢ í™•ì‹¤í•œ ì •ë³´ë§Œ ê²°ê³¼ì— í¬í•¨
                        </small>
                    </div>
                </div>
            `;

            try {
                const pdfText = await extractPDFText(uploadedFile);
                
                analyzeBtn.textContent = 'ë°ì´í„° ë¶„ì„ ì¤‘...';
                resultDiv.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <div class="loading-spinner"></div>
                        <h4 style="margin: 1rem 0;">ğŸ” PDF í…ìŠ¤íŠ¸ì—ì„œ ì •í™•í•œ ë°ì´í„° ì¶”ì¶œ ì¤‘...</h4>
                        <p>ì •ê·œí‘œí˜„ì‹ íŒ¨í„´ ë§¤ì¹­ìœ¼ë¡œ í™•ì‹¤í•œ ì •ë³´ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                
                const analysisData = extractAccurateDataFromPDF(pdfText);
                const analysisResult = generateAccuratePDFAnalysis(analysisData);
                resultDiv.innerHTML = analysisResult;
                
                showToast('PDF ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
                setTimeout(() => {
                    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
            } catch (error) {
                console.error('PDF ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
                resultDiv.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #dc3545;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âŒ</div>
                        <h4>PDF ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h4>
                        <p style="margin: 1rem 0;">${error.message}</p>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: left;">
                            <small>
                            <strong>ê°€ëŠ¥í•œ ì›ì¸:</strong><br>
                            â€¢ ìŠ¤ìº”ëœ ì´ë¯¸ì§€ PDF (í…ìŠ¤íŠ¸ ì¶”ì¶œ ë¶ˆê°€)<br>
                            â€¢ ì•”í˜¸í™”ëœ PDF íŒŒì¼<br>
                            â€¢ ì†ìƒëœ PDF íŒŒì¼<br>
                            â€¢ ë³µì¡í•œ PDF êµ¬ì¡°<br><br>
                            <strong>í•´ê²° ë°©ë²•:</strong><br>
                            â€¢ í…ìŠ¤íŠ¸ ê¸°ë°˜ PDF íŒŒì¼ ì‚¬ìš©<br>
                            â€¢ ë‹¤ë¥¸ PDF íŒŒì¼ë¡œ ì¬ì‹œë„
                            </small>
                        </div>
                    </div>
                `;
                showToast('PDF ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ğŸš€ ì‹¤ì œ PDF í…ìŠ¤íŠ¸ ë¶„ì„ ì‹œì‘';
            }
        }

        // ë¦¬í¬íŠ¸ ìƒì„± í•¨ìˆ˜ (ìƒ‰ìƒ ì œê±°, í‘ë°± ë²„ì „)
        function generateAccuratePDFAnalysis(data) {
            const filename = uploadedFile.name;
            const currentTime = new Date().toLocaleString('ko-KR');
            
            const extractedItems = Object.values(data).filter(value => {
                if (value === null || value === undefined) return false;
                if (typeof value === 'object' && value !== null) {
                    return Object.values(value).some(v => v !== null && v !== undefined);
                }
                return true;
            }).length;
            
            const totalItems = Object.keys(data).length;
            const successRate = Math.round((extractedItems / totalItems) * 100);
            
            return `
                <div class="pdf-analysis-result">
                    <div class="analysis-header">
                        <h3 class="analysis-title">ğŸ“‹ ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì¼ë„2ë™ ì¹´í˜ ìƒê¶Œë¶„ì„ ë¦¬í¬íŠ¸</h3>
                        <p class="analysis-subtitle">
                            ë¶„ì„ì¼ì‹œ: ${currentTime} | íŒŒì¼ëª…: ${filename}<br>
                            ì¶”ì¶œ ì„±ê³µë¥ : ${successRate}% (${extractedItems}/${totalItems}í•­ëª©)
                        </p>
                    </div>

                    <div class="analysis-content">â–  ê¸°ë³¸ ë¶„ì„ ì •ë³´
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–£ ë¶„ì„ ì§€ì—­: ${data.region || 'ì •ë³´ ì—†ìŒ'}
â–£ ë¶„ì„ ì—…ì¢…: ${data.business || 'ì •ë³´ ì—†ìŒ'}
â–£ ë¶„ì„ ê¸°ì¤€: ì‹¤ì œ PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ
â–£ ì¶”ì¶œ ë°©ì‹: PDF.js + ì •ê·œí‘œí˜„ì‹ ì •í™•í•œ íŒŒì‹±

â–  ì—…ì†Œ í˜„í™© ë¶„ì„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–¶ ì´ ì—…ì†Œ ìˆ˜: ${data.totalStores ? data.totalStores + 'ê°œ' : 'ì •ë³´ ì—†ìŒ'}
â–¶ ì „ì›”ëŒ€ë¹„ ì¦ê°: ${data.storeChange ? data.storeChange + '%' : 'ì •ë³´ ì—†ìŒ'}

â–  ë§¤ì¶œ í˜„í™© ë¶„ì„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–¶ ì›”í‰ê·  ë§¤ì¶œì•¡: ${data.avgSales ? parseInt(data.avgSales).toLocaleString() + 'ë§Œì›' : 'ì •ë³´ ì—†ìŒ'}
â–¶ ë§¤ì¶œ ì¦ê°ë¥ : ${data.salesChange ? (parseFloat(data.salesChange) >= 0 ? '+' : '') + data.salesChange + '%' : 'ì •ë³´ ì—†ìŒ'}
â–¶ ì›”í‰ê·  ë§¤ì¶œê±´ìˆ˜: ${data.avgTransactions ? parseInt(data.avgTransactions).toLocaleString() + 'ê±´' : 'ì •ë³´ ì—†ìŒ'}
â–¶ ê±°ë˜ëŸ‰ ë³€í™”: ${data.transactionChange ? (parseFloat(data.transactionChange) >= 0 ? '+' : '') + data.transactionChange + '%' : 'ì •ë³´ ì—†ìŒ'}

â–  ê³ ê° íŠ¹ì„± ë¶„ì„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–¶ ì„±ë³„ ë¶„í¬: ${data.genderRatio.male && data.genderRatio.female ? `ë‚¨ì„± ${data.genderRatio.male}% / ì—¬ì„± ${data.genderRatio.female}%` : 'ì •ë³´ ì—†ìŒ'}

â–  ìµœì  ìš´ì˜ ì‹œê°„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–¶ ìµœê³  ë§¤ì¶œ ì‹œê°„ëŒ€: ${data.peakHours ? data.peakHours.time + (data.peakHours.percentage ? ` (${data.peakHours.percentage}%)` : '') : 'ì •ë³´ ì—†ìŒ'}
â–¶ ìµœê³  ë§¤ì¶œ ìš”ì¼: ${data.bestDay ? data.bestDay.day + (data.bestDay.percentage ? ` (${data.bestDay.percentage}%)` : '') : 'ì •ë³´ ì—†ìŒ'}

â–  ì¸êµ¬ í˜„í™© ë¶„ì„  
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–¶ ì¼í‰ê·  ìœ ë™ì¸êµ¬: ${data.footTraffic ? parseInt(data.footTraffic).toLocaleString() + 'ëª…' : 'ì •ë³´ ì—†ìŒ'}
â–¶ ìœ ë™ì¸êµ¬ ì¦ê°ë¥ : ${data.footTrafficChange ? (parseFloat(data.footTrafficChange) >= 0 ? '+' : '') + data.footTrafficChange + '%' : 'ì •ë³´ ì—†ìŒ'}
â–¶ ê±°ì£¼ ì¸êµ¬ìˆ˜: ${data.residentPopulation ? parseInt(data.residentPopulation).toLocaleString() + 'ëª…' : 'ì •ë³´ ì—†ìŒ'}
â–¶ ì§ì¥ ì¸êµ¬ìˆ˜: ${data.workingPopulation ? parseInt(data.workingPopulation).toLocaleString() + 'ëª…' : 'ì •ë³´ ì—†ìŒ'}
â–¶ ì´ ì„¸ëŒ€ìˆ˜: ${data.households ? parseInt(data.households).toLocaleString() + 'ì„¸ëŒ€' : 'ì •ë³´ ì—†ìŒ'}

â–  AI ìƒì„± í•µì‹¬ ì¸ì‚¬ì´íŠ¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${generateInsights(data)}

â–  ë¶„ì„ ì™„ë£Œ ë° í’ˆì§ˆ ì •ë³´
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–£ ì¶”ì¶œ ì„±ê³µ: ${extractedItems}ê°œ í•­ëª© (ì´ ${totalItems}ê°œ ì¤‘)
â–£ ë¶„ì„ ì •í™•ë„: ${successRate}% (ì‹¤ì œ PDF í…ìŠ¤íŠ¸ ê¸°ë°˜)
â–£ ì¶”ì¶œ ë°©ì‹: PDF.js ë¼ì´ë¸ŒëŸ¬ë¦¬ + ì •ê·œí‘œí˜„ì‹ íŒ¨í„´ ë§¤ì¹­

â–£ ì¶”ì¶œ ì„±ê³µí•œ ì£¼ìš” ì •ë³´:
${getSuccessfulExtractions(data)}

â–£ ì¶”ì¶œë˜ì§€ ì•Šì€ ì •ë³´:
${getFailedExtractions(data)}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–  ë¶„ì„ ê²°ë¡ 
ì´ ë¶„ì„ì€ ì—…ë¡œë“œëœ PDFì—ì„œ ì‹¤ì œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ì—¬ ìƒì„±í–ˆìŠµë‹ˆë‹¤.
ì‹¤ì œ PDF ë‚´ìš©: "ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì œì£¼ì‹œ ì¼ë„2ë™" "ì¹´í˜" "6ê°œ" "650ë§Œì›" "1.6%" ë“±
í™•ì‹¤í•˜ì§€ ì•Šì€ ì •ë³´ëŠ” 'ì •ë³´ ì—†ìŒ'ìœ¼ë¡œ ëª…ì‹œí•˜ì—¬ ì •í™•ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.</div>
                </div>
            `;
        }

        // ì„±ê³µì ìœ¼ë¡œ ì¶”ì¶œëœ í•­ëª© í‘œì‹œ
        function getSuccessfulExtractions(data) {
            const successful = [];
            
            if (data.region) successful.push('â–¶ ë¶„ì„ ì§€ì—­');
            if (data.business) successful.push('â–¶ ë¶„ì„ ì—…ì¢…');
            if (data.totalStores) successful.push('â–¶ ì´ ì—…ì†Œ ìˆ˜');
            if (data.avgSales) successful.push('â–¶ ì›”í‰ê·  ë§¤ì¶œì•¡');
            if (data.salesChange) successful.push('â–¶ ë§¤ì¶œ ì¦ê°ë¥ ');
            if (data.avgTransactions) successful.push('â–¶ ì›”í‰ê·  ë§¤ì¶œê±´ìˆ˜');
            if (data.footTraffic) successful.push('â–¶ ì¼í‰ê·  ìœ ë™ì¸êµ¬');
            if (data.footTrafficChange) successful.push('â–¶ ìœ ë™ì¸êµ¬ ì¦ê°ë¥ ');
            if (data.peakHours) successful.push('â–¶ ìµœê³  ë§¤ì¶œ ì‹œê°„ëŒ€');
            if (data.bestDay) successful.push('â–¶ ìµœê³  ë§¤ì¶œ ìš”ì¼');
            if (data.genderRatio.male && data.genderRatio.female) successful.push('â–¶ ì„±ë³„ ë¶„í¬');
            if (data.residentPopulation) successful.push('â–¶ ê±°ì£¼ ì¸êµ¬ìˆ˜');
            if (data.workingPopulation) successful.push('â–¶ ì§ì¥ ì¸êµ¬ìˆ˜');
            if (data.households) successful.push('â–¶ ì´ ì„¸ëŒ€ìˆ˜');
            
            return successful.length > 0 ? successful.join('\n') : 'â–¶ ì¶”ì¶œëœ ì •ë³´ ì—†ìŒ';
        }

        // ì¶”ì¶œ ì‹¤íŒ¨í•œ í•­ëª© í‘œì‹œ
        function getFailedExtractions(data) {
            const failed = [];
            
            if (!data.region) failed.push('â–¶ ë¶„ì„ ì§€ì—­');
            if (!data.business) failed.push('â–¶ ë¶„ì„ ì—…ì¢…');
            if (!data.totalStores) failed.push('â–¶ ì´ ì—…ì†Œ ìˆ˜');
            if (!data.avgSales) failed.push('â–¶ ì›”í‰ê·  ë§¤ì¶œì•¡');
            if (!data.salesChange) failed.push('â–¶ ë§¤ì¶œ ì¦ê°ë¥ ');
            if (!data.avgTransactions) failed.push('â–¶ ì›”í‰ê·  ë§¤ì¶œê±´ìˆ˜');
            if (!data.footTraffic) failed.push('â–¶ ì¼í‰ê·  ìœ ë™ì¸êµ¬');
            if (!data.footTrafficChange) failed.push('â–¶ ìœ ë™ì¸êµ¬ ì¦ê°ë¥ ');
            if (!data.peakHours) failed.push('â–¶ ìµœê³  ë§¤ì¶œ ì‹œê°„ëŒ€');
            if (!data.bestDay) failed.push('â–¶ ìµœê³  ë§¤ì¶œ ìš”ì¼');
            if (!data.genderRatio.male || !data.genderRatio.female) failed.push('â–¶ ì„±ë³„ ë¶„í¬');
            if (!data.residentPopulation) failed.push('â–¶ ê±°ì£¼ ì¸êµ¬ìˆ˜');
            if (!data.workingPopulation) failed.push('â–¶ ì§ì¥ ì¸êµ¬ìˆ˜');
            if (!data.households) failed.push('â–¶ ì´ ì„¸ëŒ€ìˆ˜');
            
            return failed.length > 0 ? failed.join('\n') : 'â–¶ ëª¨ë“  ì •ë³´ ì¶”ì¶œ ì„±ê³µ';
        }

        // ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.background = '#f0f8f0';
            event.currentTarget.style.borderColor = '#45A049';
            event.currentTarget.style.transform = 'scale(1.02)';
        }

        function handleDragLeave(event) {
            event.currentTarget.style.background = '#f8fff8';
            event.currentTarget.style.borderColor = '#4CAF50';
            event.currentTarget.style.transform = 'scale(1)';
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.style.background = '#f8fff8';
            event.currentTarget.style.borderColor = '#4CAF50';
            event.currentTarget.style.transform = 'scale(1)';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type === 'application/pdf') {
                    if (validateFileSize(file)) {
                        uploadedFile = file;
                        document.getElementById('pdf-analyze-btn').disabled = false;
                        updateUploadZone(file);
                        showToast(`PDF íŒŒì¼ "${file.name}"ì´ ë“œë˜ê·¸ì•¤ë“œë¡­ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    }
                } else {
                    showToast('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                }
            }
        }

        // ì‹¤ì‹œê°„ ë¶„ì„ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function refreshIframe() {
            const iframe = document.querySelector('#realtime iframe');
            if (iframe) {
                iframe.src = iframe.src;
                showToast('ì†Œë“¬ ì‹¤ì‹œê°„ ë¶„ì„ì´ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        function toggleFullscreen() {
            const container = document.querySelector('#realtime .iframe-container');
            if (container) {
                if (!document.fullscreenElement) {
                    container.requestFullscreen().then(() => {
                        showToast('ì „ì²´í™”ë©´ìœ¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ESCí‚¤ë¡œ í•´ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'info');
                    }).catch(() => {
                        showToast('ì „ì²´í™”ë©´ ëª¨ë“œë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.', 'warning');
                    });
                } else {
                    document.exitFullscreen().then(() => {
                        showToast('ì „ì²´í™”ë©´ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                    });
                }
            }
        }

        function openInNewWindow() {
            const url = 'https://bigdata.sbiz.or.kr/#/openApi/detail?certKey=211032e7c09b05f6c5ed67985eae269d6446e93a8748ab63602fb121b44b7943';
            const popup = window.open(url, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            if (popup) {
                showToast('ì†Œë“¬ ì‹¤ì‹œê°„ ë¶„ì„ì„ ìƒˆ ì°½ì—ì„œ ì—´ì—ˆìŠµë‹ˆë‹¤.', 'info');
            } else {
                showToast('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
            }
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast-message');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast-message';
            
            const bgColor = {
                'success': '#4CAF50',
                'error': '#f44336', 
                'warning': '#ff9800',
                'info': '#2196F3'
            }[type] || '#2196F3';
            
            const icon = {
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            }[type] || 'â„¹ï¸';
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${bgColor};
                color: white;
                border-radius: 8px;
                z-index: 10000;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease-out;
                max-width: 350px;
                word-wrap: break-word;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            `;
            
            // ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€
            if (!document.querySelector('#toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { 
                            transform: translateX(100%); 
                            opacity: 0; 
                        }
                        to { 
                            transform: translateX(0); 
                            opacity: 1; 
                        }
                    }
                    @keyframes slideOut {
                        from { 
                            transform: translateX(0); 
                            opacity: 1; 
                        }
                        to { 
                            transform: translateX(100%); 
                            opacity: 0; 
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            document.body.appendChild(toast);
            
            // í´ë¦­í•´ì„œ ë‹«ê¸°
            toast.addEventListener('click', () => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            });
            
            // ìë™ìœ¼ë¡œ ë‹«ê¸°
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                }
            }, type === 'error' ? 5000 : 3000);
        }

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.addEventListener('keydown', function(e) {
            // ESC í‚¤ë¡œ ì „ì²´í™”ë©´ í•´ì œ
            if (e.key === 'Escape' && document.fullscreenElement) {
                document.exitFullscreen();
            }
            
            // Ctrl+Uë¡œ íŒŒì¼ ì—…ë¡œë“œ (PDF íƒ­ì—ì„œë§Œ)
            if (e.ctrlKey && e.key === 'u' && currentTab === 'pdf') {
                e.preventDefault();
                document.getElementById('fileInput').click();
            }
            
            // Enter í‚¤ë¡œ ë¶„ì„ ì‹œì‘ (AI ë¶„ì„ íƒ­ì—ì„œë§Œ)
            if (e.key === 'Enter' && currentTab === 'ai-analysis') {
                const addressInput = document.getElementById('address-input');
                if (document.activeElement === addressInput) {
                    document.getElementById('analyze-btn').click();
                }
            }
        });

        // ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ì²´í¬
        function checkBrowserCompatibility() {
            const isCompatible = 
                typeof pdfjsLib !== 'undefined' &&
                'requestFullscreen' in document.documentElement &&
                'addEventListener' in window;
                
            if (!isCompatible) {
                showToast('ì¼ë¶€ ê¸°ëŠ¥ì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤. ìµœì‹  ë¸Œë¼ìš°ì € ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.', 'warning');
            }
            
            return isCompatible;
        }

        // ì´ˆê¸° í˜¸í™˜ì„± ì²´í¬
        setTimeout(() => {
            checkBrowserCompatibility();
        }, 1000);
    </script>
</body>
</html>